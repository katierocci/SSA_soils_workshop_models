---
title: "Run_models_AfSIS"
output: html_document
date: "2025-07-22"
authors: "Soil-climate feedback across sub-Saharan Africa Workshop Participants"
---

#Load libraries needed to run MIMICS and Millennial
```{r}
library(FME)
library(here)
library(tidyverse)
library(viridis)
library(DT)
library(purrr)
library(Metrics)
library(SoilR)

# safe_colorblind_palette <- c("#88CCEE", "#CC6677", "#DDCC77", "#117733", "#332288", "#AA4499", 
#                              "#44AA99", "#999933", "#882255", "#661100", "#6699CC", "#888888",
#                              "#E69F00", "#D55E00")

#load mimics model components
source(here("ODEs/RXEQ.R"))
source(here("functions/calc_Tpars.R"))
source(here("functions/MIMICS_calc_steady_state_pools.R"))

#load millennial model components
source(here("functions/run_functions.R")) #R script that contains calls to run model
source(here("ODEs/derivs_V2_MM.R")) #The official version of Millennial V2

#load century model components
source(here("functions/run_functions_Century.R")) #R script that contains calls to run model
source(here("ODEs/derivs_Century.R")) #Century ODEs
```

#Load forcing data
```{r}
## AfSIS data
afsis_data <- read.csv("forcing_data/afsis_ref_updated9.csv", as.is = T)

## Prepare forcing data
forcing_data <- afsis_data %>% 
  tibble::rowid_to_column("Set") %>% 
  filter(Depth == 'Topsoil') %>% 
  filter(CORG <= 20)

# match MIMICS names
forcing_data_MIMICS <- forcing_data %>% 
  mutate(npp_modis.gC.m2.yr = npp_modis*1000) %>%
  drop_na(npp_modis.gC.m2.yr, pH, Clay_2um, LIG_N, stemp, sm, Clay_63um, bd_extracted,
          Litterfall.gC.m2.yr) %>%
  select(Set, SSN, ANPP = npp_modis.gC.m2.yr, 
         CLAY = Clay_2um,
         lig_N = LIG_N,
         TSOI = stemp,
         theta_liq = sm,
         Depth = Depth)

# match Millennial names
forcing_data_Millennial <- forcing_data %>% 
  mutate(npp_modis.gC.m2.d = npp_modis*1000/365) %>%
  drop_na(npp_modis.gC.m2.d, pH, Clay_2um, LIG_N, stemp, sm, Clay_63um, bd_extracted,
          Litterfall.gC.m2.yr) %>%
  dplyr::select(Set, param_pH = pH, 
                param_bulkd = bd_extracted, 
                param_claysilt = Clay_63um, 
                forc_st = stemp, 
                forc_sw = sm, 
                forc_npp = npp_modis.gC.m2.d,
                Latitude = Latitude,
                Longitude = Longitude,
                SSN = SSN,
                Depth = Depth) %>% 
  mutate(param_bulkd = param_bulkd*1000*0.2, 
         param_pc = 0.86, #1000 converts from g/cm3 to kg/m3, 0.2 for top 20 cm
         site_id = row_number()) 

# Forcing data Century
# https://search.r-project.org/CRAN/refmans/SoilR/html/CenturyModel.html

forcing_data_Century <- forcing_data %>%
  drop_na(Litterfall.gC.m2.yr, NPP.gC.m2.d, Clay_2um, Clay_63um, stemp, 
          sm, pH, bd_extracted, LIG_N) %>%
  mutate(npp_modis.gC.m2.d = npp_modis*1000/365, #Century units now same as Millennial
         param_claysilt = Clay_63um/100, #fraction in Century
         forc_st = stemp, 
         forc_sw = sm, 
         forc_npp = npp_modis.gC.m2.d,
         LN = LIG_N, 
         LigFrac = LIG/100,
         Soil_Organic_Carbon_kg_m2 = CORG*10*bd_extracted*20/100,
         input_to_metlitter = 0.85 - 0.013 * LN,
         site_id = row_number()) %>%
  dplyr::select(SSN, forc_st, forc_sw, forc_npp, LN, param_claysilt, LigFrac, 
                Soil_Organic_Carbon_kg_m2, input_to_metlitter, site_id)

```

#Run Century at AfSIS sites (after Abramoff et al. 2021)
```{r}
# Read in parameters - Described in Table A1 of Abramoff et al. (2021)
parameters.file <- read.table(here("parameters/soilpara_in_century.txt")) #default
#parameters.file <- read.table(here("parameters/soilpara_in_fit_SSA_Century.txt")) #fitted

#uncomment next two code chunks for fitted
parameters.MCMC <- read.csv("parameters/Century_MCMC_out_SingleBest_112625.csv") #MCMC fitted
parameters.file <- parameters.file %>% 
  mutate(V2 = case_when(
    V1 == "w1" ~ V2*parameters.MCMC$w1_x,
    V1 == "w2" ~ V2*parameters.MCMC$w2_x,
    V1 == "t3" ~ V2*parameters.MCMC$t3_x,
    V1 == "t4" ~ V2*parameters.MCMC$t4_x,
    V1 == "k_active" ~ V2*parameters.MCMC$k_active_x,
    V1 == "k_slow" ~ V2*parameters.MCMC$k_slow_x,
    V1 == "k_passive" ~ V2*parameters.MCMC$k_passive_x,
    V1 == "metlitter_to_active" ~ V2*parameters.MCMC$metlitter_to_active_x,
    V1 == "strlitter_to_active" ~ V2*parameters.MCMC$strlitter_to_active_x,
    V1 == "strlitter_to_slow" ~ V2*parameters.MCMC$strlitter_to_slow_x,
    TRUE ~ V2  # Keep original value if no condition met
  ))
parameters <- as.list(parameters.file$V2)
names(parameters) <- parameters.file$V1

# Function to run model for one row of site parameters
run_model_for_site <- function(site_row, base_params) {
  # Copy full parameter list
  site_params <- as.list(base_params)
  #print(paste("k_active being used:", site_params$k_active))
  # Override default site-specific value with values from AfSIS
  site_params$input_to_metlitter <- as.numeric(site_row$input_to_metlitter)
  site_params$param_claysilt <- as.numeric(site_row$param_claysilt)
  site_params$LigFrac <- as.numeric(site_row$LigFrac)
    
# Format input data
input_for_site <- data.frame(
  forc_st  = rep(as.numeric(site_row$forc_st), 365),
  forc_sw  = rep(as.numeric(site_row$forc_sw), 365),
  forc_npp = rep(as.numeric(site_row$forc_npp), 365),
  stringsAsFactors = FALSE
)

# Run the model with an error-catching wrapper
  result <- tryCatch({
    Solve_Model_Century(input_for_site, derivs_Century, site_params)
  }, error = function(e) {
    warning(paste("Model failed for site:", site_row$site_id, ":", e$message))
    return(NULL)
  })

  if (is.null(result)) return(NULL)

  pool_df <- as.data.frame(t(result$y))
  pool_df$site_id <- site_row$site_id
  return(pool_df)
}

# Apply model across all rows of the site parameter dataframe
results_list <- apply(forcing_data_Century, 1, function(row) {
  row <- as.list(row)  # Convert row to list for easy referencing
  #print(parameters$k_active)
  run_model_for_site(row, parameters)
})

# Combine all into one dataframe
Century_ss <- dplyr::bind_rows(results_list)
Century_ss$site_id <- as.integer(Century_ss$site_id)

# Merge model outputs with original site parameters if needed
Century_ss_AllSites <- forcing_data_Century %>%
  left_join(Century_ss, by = "site_id") %>%
  mutate(Soil_Organic_Carbon_kg_m2 = (ACTIVE + SLOW + PASSIVE) / 1000, #StrLitter + MetLitter + 
         Type = "Century")

# View final result
hist(Century_ss_AllSites$Soil_Organic_Carbon_kg_m2)

```


#Run MIMICS at AfSIS sites
```{r}
#load MIMICS parameters here to ensure these are not changed before running
   #just exist in global environment so are susceptible to overwriting
source(here("parameters/MIMICS_parameters_sandbox_20231129.R"))

#IF using parameterized MIMICS uncomment lines of code preceding model run
MCMC_SingleBest <- read.csv('AfSIS_MIMICS_MCMC_Parameterized.csv')
Tau_MULT <<- Tau_MULT*MCMC_SingleBest$Tau_x
desorb_MULT <<- desorb_MULT*MCMC_SingleBest$desorb_x
fPHYS_MULT <<- fPHYS_MULT*MCMC_SingleBest$fPHYS_x
Vslope_MULT <<- Vslope_MULT*MCMC_SingleBest$Vslope_x
Vint_MULT <<- Vint_MULT*MCMC_SingleBest$Vint_x
Kslope_MULT <<- Kslope_MULT*MCMC_SingleBest$Kslope_x
Kint_MULT <<- Kint_MULT*MCMC_SingleBest$Kint_x
CUE_MULT <<- CUE_MULT*MCMC_SingleBest$CUE_x

#run the model for all sites
MIMruns <- forcing_data_MIMICS %>% 
  split(1:nrow(forcing_data_MIMICS)) %>% 
  purrr::map(~ MIMICS_SS(df = .))

MIMICS_ss_AllSites <- lapply(MIMruns, MIMICS_SS_format) %>% 
  bind_rows()

MIMICS_ss_AllSites <- MIMICS_ss_AllSites %>% 
  mutate(Soil_Organic_Carbon_kg_m2 = (SOMa + SOMc + SOMp + MICr + MICk), Type = "MIMICS")

hist(MIMICS_ss_AllSites$Soil_Organic_Carbon_kg_m2) #mg C/ cm3 = kg / m3

#Compare pools sizes and variation
MIM_ss_long <- MIMICS_ss_AllSites %>% 
  select(SET,LITm, LITs, MICr, MICk, SOMa, SOMc, SOMp) %>% 
  pivot_longer(cols = 2:8, names_to = 'Pool', values_to = 'C_content')

# ggplot(MIM_ss_long) + 
#   geom_boxplot(aes(x = Pool, y = C_content, fill = Pool, group = Pool)) + 
#   ylab("Pool C content 0-30cm (mgC/cm3") + 
#   xlab("Pool") + 
#   scale_fill_manual(values = safe_colorblind_palette, guide = "none") + 
#   theme_bw(base_size = 14)

#compare inputs and outputs
ggplot(MIMICS_ss_AllSites) + 
  geom_point(aes(x = CLAY, y = SOMp, colour = LIG_N), size = 4) + 
  ylab("SOMp 0-20cm (mgC/cm3)") + 
  xlab("Clay") +
  theme_bw(base_size = 14)
```

#Run Millennial at AfSIS sites
```{r}
# Read in parameters - Described in Table A1 of Abramoff et al. (2021)
# parameters.file <- read.table(here("parameters/soilpara_in_fit_with_qmax.txt")) #default
parameters.file <- read.table(here("parameters/soilpara_in_fit_SSA_Millennial.txt")) #fitted
parameters <- as.list(parameters.file$V2)
names(parameters) <- parameters.file$V1

# Function to run model for one row of site parameters
run_model_for_site <- function(site_row, base_params) {
  # Copy full parameter list
  site_params <- as.list(base_params)
  # Override default site-specific value with values from AfSIS
  site_params$param_pH       <- as.numeric(site_row$param_pH)
  site_params$param_bulkd    <- as.numeric(site_row$param_bulkd)
  site_params$param_pc       <- as.numeric(site_row$param_pc)
  site_params$param_claysilt <- as.numeric(site_row$param_claysilt)
    
# Format input data
input_for_site <- data.frame(
  forc_st  = rep(as.numeric(site_row$forc_st), 365),
  forc_sw  = rep(as.numeric(site_row$forc_sw), 365),
  forc_npp = rep(as.numeric(site_row$forc_npp), 365),
  stringsAsFactors = FALSE
)

# Run the model with an error-catching wrapper
  result <- tryCatch({
    Solve_Model(input_for_site, derivs_V2_MM, site_params)
  }, error = function(e) {
    warning(paste("Model failed for site:", site_row$site_id, ":", e$message))
    return(NULL)
  })

  if (is.null(result)) return(NULL)

  pool_df <- as.data.frame(t(result$y))
  pool_df$site_id <- site_row$site_id
  return(pool_df)
}

# Apply model across all rows of the site parameter dataframe
results_list <- apply(forcing_data_Millennial, 1, function(row) {
  row <- as.list(row)  # Convert row to list for easy referencing
  run_model_for_site(row, parameters)
})

# Combine all into one dataframe
Millennial_ss <- dplyr::bind_rows(results_list)
Millennial_ss$site_id <- as.integer(Millennial_ss$site_id)

# Merge model outputs with original site parameters if needed
Millennial_ss_AllSites <- forcing_data_Millennial %>%
  left_join(Millennial_ss, by = "site_id") %>%
  mutate(Soil_Organic_Carbon_kg_m2 = (POM + LMWC + AGG + MIC + MAOM) / 1000, 
         Type = "Millennial")

# View final result
hist(Millennial_ss_AllSites$Soil_Organic_Carbon_kg_m2)
```

# Combine output
```{r}
# Default Runs
# all_models_default <- rbind(MIMICS_ss_AllSites %>%
#                               dplyr::select(SSN, Soil_Organic_Carbon_kg_m2, Type),
#                             Millennial_ss_AllSites %>%
#                               dplyr::select(SSN, Soil_Organic_Carbon_kg_m2, Type),
#                             Century_ss_AllSites %>%
#                               dplyr::select(SSN, Soil_Organic_Carbon_kg_m2, Type),
#                             forcing_data %>%
#                               mutate(Soil_Organic_Carbon_kg_m2 = CORG*10*bd_extracted*20/100,
#                                      Type = "Observed") %>%
#                               select(SSN, Soil_Organic_Carbon_kg_m2, Type))
# 
# write.csv(all_models_default, row.names = FALSE,
#           paste0("./model_output/all_model_results_default_run_",
#           Sys.Date(), ".csv"))
# 
# ggplot(all_models_default, aes(x = Soil_Organic_Carbon_kg_m2)) +
#   geom_histogram(bins = 30, fill = "steelblue", color = "white") +
#   facet_wrap(~ Type, ncol = 1)

# Fitted Runs
all_models_fitted <- rbind(MIMICS_ss_AllSites %>%
                       dplyr::select(SSN, Soil_Organic_Carbon_kg_m2, Type),
                     Millennial_ss_AllSites %>%
                       dplyr::select(SSN, Soil_Organic_Carbon_kg_m2, Type),
                     Century_ss_AllSites %>%
                              dplyr::select(SSN, Soil_Organic_Carbon_kg_m2, Type),
                     forcing_data %>%
                       mutate(Soil_Organic_Carbon_kg_m2 = CORG*10*bd_extracted*20/100,
                              Type = "Observed") %>%
                       select(SSN, Soil_Organic_Carbon_kg_m2, Type))
write.csv(all_models_fitted, row.names = FALSE,
          paste0("./model_output/all_model_results_fitted_run_",
          Sys.Date(), ".csv"))

ggplot(all_models_fitted, aes(x = Soil_Organic_Carbon_kg_m2)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "white") +
  facet_wrap(~ Type, ncol = 1)

```


